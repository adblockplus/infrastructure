#!/usr/bin/env python

import distutils.spawn
import io
import os
import subprocess
import sys

if distutils.spawn.find_executable('puppet') \
    and distutils.spawn.find_executable('hiera'):
    sys.exit(os.EX_OK)

PUPPETLABS_SOURCES = '''
deb http://apt.puppetlabs.com precise main
deb-src http://apt.puppetlabs.com precise main'''

PUPPETLABS_PREFS = '''
# Puppetlabs packages (e.g. hiera) would attempt to install a puppet 3.x
# or later release (which is not available in precise) if not pinned here
Package: puppet puppet-common
Pin: version 2.7.26-*
Pin-Priority: 501

# See https://issues.adblockplus.org/ticket/3706#comment:4
Package: facter
Pin: version 1.*
Pin-Priority: 501'''

PUPPETLABS_GPG_KEY = '''
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.12 (GNU/Linux)

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
TEM/9bZGPdJsS1mwUUy3ukDW1rhOodxojhN1XhT3f7X9Cl8lKxKw1tloRijfL3n4
njwk6hEyKaURTo4iOs12HDlBZV3zhWONNZTvqrFMkz4OB+q8RGpfO8G4Mbba+fNQ
2At+cAWmGCoZeX3KfyRtqYe6vtKJf5ptQZgjl3EFPl6OxKjopzomB7o9lXbxARgO
6Pf9NSyYwlv0sNfy88N5iSsa7Sw7yi9t9tO5KFGoGYLmXXgyjvNZrE8KMh6/hJOW
HsW19noVdogd73q+gjRAl+eZ4J1nKpbSPkbufNoD8uB/j3rr5/sRJrtvVnMTJXwC
iTItalyg7XRJSQ9kAqzvRlxdGobo95kCDgRMOAxgARAA4fq6ycOnc1Q6ReWyMBol
tMxYXODCmmSfQGYXP/SdBzynY/jMHCfwA5jLi1QGWpth/vvAlWU1nutXMlitYSne
NXZhDDnLEsB1dhPvEQtfoe4q3C0WFXMi/6a9lZ0dHhmbo7FLL1q+h7mh83PGYqCa
Omcq4LwqqAAe6+zcKR+cEDMd6M7nYh3p28FQhyCq0Xq2lIq9uksJ/uY+v/blwL3S
RGRGzeXzo9tOqvgwJ1nuS0tm0KQgu2ZZgJDV2H5vY8chftPvTTQK0cMJY+5GPVFh
ijtynKbnC73f7VIJM8NNSPD/j4WbTvjI8NAtIy43/WBgqCd+19muizmmVfHIMOpG
iKcskVCmDWTJYYC8277hpJV1WGMT/EzxfzxJRkCjk23KqUXuRs87Rt391iWQ1zQk
6kJOUFluzjdBnDbik675WtEG0SzPJanRO3lwBWIX1I8jgUPapH6KYpARLACdeXDD
YTMqGh1Z8rbLxDGZgbdf7LaHX2qYVWotrvr1YdF38frgNxvLzzjNRtpmlmtTYVVC
og22zYQ2+MEs6AfTUhYM24ORcCzE6GZIWhxD2sqjiXSt/JRcHKjqAHCufJGyV8bL
x9jyqW39GKF06y0RtX4syiLcxwxn4oSD3xbLpjN0rqTyajasJAhStQkdsjH0b/0U
uVG+YgWC42wGJYNz89mOxg0AILXzdo2JApIEIAEIAHwFAlQR+U51HQBUaGlzIGtl
eSBoYXMgdGhlIHNhbWUgMzItYml0IGtleSBpZCBhcyB0aGUgUHVwcGV0IExhYnMg
c2lnbmluZyBrZXkuCkl0IHdhcyB1c2VkIGZvciBleGFtcGxlcyBvbiBodHRwczov
L2V2aWwzMi5jb20vAAoJEA9lhC1L1uwwWlEQANbB+dzLLbgmZdjvZmdSJEkVYC1Y
kdRhopuIEWPQ8GLLGjVESiYZ7NApqZVCsDHvlbMVTp052jNcCRhsIKDEWYz18+Op
hPA2tuls5vdm5+OLnPG9uH89mWVNg/LXo2oY4goQNR32iHmUxA/EGLfBI2sp24q1
shK0SqACjY/wEzEYewtyHGyiWOoqMvJnhq2/aaasitCMqz3xfwz57t0CkQ7Wx6A7
N12SYFT3oO2XL+jkSfK6C4gN+dbjHyxcVWm5mo0W/LxwuLUzDZ3DCGXs7EMuk3+M
OoP3gI+qC2lhowg+t2ZkjVDocmQgwap3IrLluaqSd3JecLuFjj1n6YREyTkNXusL
gLgEIfjgSxum51Bklyp/O8XIa5YNPSG78juURNCPL8t1fH/R5E1QYKubpAzGOvSW
C87ib74pCjnnkJ8WvER3016LFyUxIP9EmOceI8GwLd5L6sUmydV/AIIVztOlXLrJ
2RYeyMYwwUzy5AceB5vwt81RUzO1Q3bXPhcD+fjmc0D7ET0Bndba+TpB1iORdjoL
wc0UqwQcFYwBP2fhF5N8cgpNPQwyx9Wq4m7v9fIW2KkQ2PFGJHEBrVc4VKWP+R2H
fh25YySCS1qSEX3hitjz+NatkQhq46BMzv6Rtq8rV0C0ASjr/2q45X2xMFVXBFcN
AOjnvAQKEYp3NUFTtEdQdXBwZXQgTGFicyBSZWxlYXNlIEtleSAoUHVwcGV0IExh
YnMgUmVsZWFzZSBLZXkpIDxpbmZvQHB1cHBldGxhYnMuY29tPokCPwQTAQIAKQIb
LwcLCQgHAwIBBhUIAgkKCwQWAgMBAh4BAheABQJTwf9vBQkLRxQPAAoJEA9lhC1L
1uwwO8IQAIaVg5hTzGfNp+Zxm4fQ3sv7114digYHqDdd8H8k8jaTJguMVMQizbVa
0FeP0pvD6P/Dlt1FvoL98z4UyM1GY/bXYVaJ6g9xbL1K2Vza2jDMMw7A+r8raC/v
ZwPrc7Vs6kkHIQxHLIW9fAHxEKpOyQwtMykNQTke31HP4yZvpaMGTicsifKgdZaA
ATx2UWz4hA2GrhY2k+KsD+SWGOCD+ZIWEzBu2uKkvGnfJmeAzkfsx/L2XO9/P2ac
V8Gm0qV3573koG1Ys1+uPsM4DWF752Sxl1/DzQCgYyv6BicGKtZ0HbHGxqGf5tPI
hHOgd67DCCx7/JMAMm1EB12m0jncCJOovRzQH99yCAZ2dycXjGzcZV+xIqpMLvZ3
SisxJFKBhYQuPp6/9zoKjQrDojIVLYZCRvidssk+kiSFUl99zKN4Xy1SyUD89H4O
3VJrnUQOz4dfF89vNevPXr2sdAU36PnsQQJ/m183FRsgastvUULiiB7Bc/YUqYUO
P1OOkwomdX11eRY3Sqh67586ICBdVlzqPKNF0oEQW/TIRdaPnSjXRN8ncmNUwICm
ua+1iNrSgygWUS6a/4/OCB8fj/xx13fBsFkFLS8ZsRZygnJYieFbaSL55eYq9GkB
rDE5Z38C/41shTGoU0BcSCMSU2tf380s9gkmkSQRwHMh6AbixAKj
=infX
-----END PGP PUBLIC KEY BLOCK-----
'''

add_key_process = subprocess.Popen(['apt-key', 'add', '-'], stdin=subprocess.PIPE)
add_key_process.communicate(PUPPETLABS_GPG_KEY)

with io.open('/etc/apt/sources.list.d/puppetlabs.list', 'wb') as handle:
    handle.write(PUPPETLABS_SOURCES)

with io.open('/etc/apt/preferences.d/puppetlabs', 'wb') as handle:
    handle.write(PUPPETLABS_PREFS)

subprocess.check_call(['apt-get', '-y', 'update'])
subprocess.check_call(['apt-get', '-y', 'install',
                       '-o', 'Dpkg::Options::=--force-overwrite',
                       'puppet', 'puppet-common', 'hiera-puppet'])

if not os.path.exists('/etc/puppet/hiera.yaml'):
    realpath = os.path.realpath(__file__)
    dirname = os.path.dirname(realpath)
    config = os.path.join(dirname, 'hiera.yaml')
    if os.path.exists(config):
        os.symlink(config, '/etc/puppet/hiera.yaml')
