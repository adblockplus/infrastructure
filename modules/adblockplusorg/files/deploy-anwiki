#!/bin/bash

anwiki_root="/var/www/adblockplus.org/anwiki"
php_root="/var/www/adblockplus.org/phproot"

temp_dir="/tmp/anwiki-$$"
rm -rf "$temp_dir"
mkdir "$temp_dir"
cd "$temp_dir"

local_anwiki_repository="/mnt/local_anwiki_repository"
if [[ -d $local_anwiki_repository ]]; then
    cp -r "$local_anwiki_repository" anwiki
    rm -r anwiki/.hg*
else
    hg clone https://hg.adblockplus.org/anwiki anwiki-hg &>/dev/null

    if [[ $? != 0 ]]; then
	echo "Unable to clone anwiki repository" >&2
	exit 1
    fi

    hg archive -R anwiki-hg -r local anwiki
fi

find anwiki/anwiki -name .htaccess -exec rm '{}' \;
find anwiki/anwiki -name index.html -exec rm '{}' \;
find anwiki/anwiki/_override -name '*.cfg.php' -exec rm '{}' \;
rm anwiki/anwiki/htaccess-DISABLED
rm anwiki/anwiki/_anwiki-override-DISABLED.inc.php

mkdir -p "$anwiki_root"
mkdir -p "$php_root"

site_dir="anwiki/anwiki"
chown -R www-data:www-data anwiki/anwiki
cp -prf "$site_dir"/{_addons,_addons-static,_override,_override-static,default,default-static,sources,anwiki.inc.php} "$anwiki_root"
cp -prf "$site_dir"/{index.php,engine.inc.php} "$php_root"

writable_dir="$anwiki_root/_writable"

mkdir -p "$writable_dir/"{status,tmp}

cache_dir="$writable_dir/cache"
rm -rf "$cache_dir"
mkdir -p "$cache_dir/"{config,content/bygroup,content/byid,content/byname,system}

chown -R www-data:www-data "$writable_dir"

aclsdriver_configrules="$anwiki_root/_override/drivers/aclsdrivers/aclsdriver_configrules/aclsdriver_configrules.cfg.php"
touch "$aclsdriver_configrules"
chown www-data "$aclsdriver_configrules"

rm -rf "$temp_dir"
