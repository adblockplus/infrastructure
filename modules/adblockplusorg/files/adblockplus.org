server {
  root /var/www/adblockplus.org/httpdocs;

  location / {
    index index.php index index.html;

    if ($arg_a = "view") {
      rewrite ^(.*) $1? permanent;
    }

    set $preferredLang en;
    if ($http_accept_language ~ ^(\w\w)\b) {
      set $preferredLang $1;
    }
    if (!-f $document_root/static/$preferredLang/index) {
      set $preferredLang en;
    }

    set $browser "firefox";
    if ($http_user_agent ~ \bChrome/\d+) {
      set $browser "chrome";
    }
    if ($http_user_agent ~ \bPresto/\d+) {
      set $browser "opera";
    }
    if ($http_user_agent ~ \bAndroid\s.*\bAppleWebKit/\d+) {
      set $browser "android";
    }

    if ($arg_a ~ ^(view|show)?$) {
      rewrite ^/(index\.html)?$ /$preferredLang/$browser redirect;
      rewrite ^/(\w\w(_\w\w)?)$ /$1/$browser redirect;
    }

    rewrite ^/(\w\w(_\w\w)?)/installation$ /$1/ permanent;
    rewrite ^/anwiki/(.*) /$1 permanent;

    if (-f $request_filename) {
      break;
    }
    if (-d $request_filename) {
      break;
    }

    set $static_uri $uri;
    if ($uri ~ ^/(\w\w(_\w\w)?)/(firefox|chrome|opera|android)) {
      set $static_uri "/$1/";
      set $browser $3;
    }
    set $static "";
    if (-f "$document_root/static$static_uri") {
      set $static "ok";
    }
    if (-d "$document_root/static$static_uri") {
      set $static "ok";
    }
    set $static "$static!$arg_a!$cookie_anwiki_anwsesscode";
    if ($static ~ ^ok!(view|show)?!$) {
      rewrite ^ /static$static_uri?browser=$browser last;
    }

    rewrite ^/(\w\w(_\w\w)?)/(firefox|chrome|opera|android) /index.php?p=$1&browser=$3 last;
    rewrite ^/(.*) /index.php?p=$1 last;
  }

  location /static/ {
      index index;
      internal;
      types {
        image/png png;
        text/xml xml;
        text/css css;
      }
      default_type text/html;
      charset utf-8;

      if ($arg_browser) {
        set $browser_class ' class="$arg_browser"';
      }
      sub_filter ' id="content"' ' id="content"$browser_class';
  }


  location ~ \.php$ {
    client_max_body_size 8m;

    if ($arg_browser) {
      set $browser_class ' class="$arg_browser"';
    }
    sub_filter ' id="content"' ' id="content"$browser_class';

    fastcgi_pass unix:/tmp/php-fastcgi.sock;
    fastcgi_index index.php;

    fastcgi_param SCRIPT_FILENAME /var/www/adblockplus.org/phproot$fastcgi_script_name;

    fastcgi_param QUERY_STRING $query_string;
    fastcgi_param REQUEST_METHOD $request_method;
    fastcgi_param CONTENT_TYPE $content_type;
    fastcgi_param CONTENT_LENGTH $content_length;

    fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_param DOCUMENT_URI $document_uri;
    fastcgi_param DOCUMENT_ROOT $document_root;
    fastcgi_param SERVER_PROTOCOL $server_protocol;

    fastcgi_param GATEWAY_INTERFACE CGI/1.1;
    fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;

    fastcgi_param REMOTE_ADDR $remote_addr;
    fastcgi_param REMOTE_PORT $remote_port;
    fastcgi_param SERVER_ADDR $server_addr;
    fastcgi_param SERVER_PORT $server_port;
    fastcgi_param SERVER_NAME $server_name;
  }
}
