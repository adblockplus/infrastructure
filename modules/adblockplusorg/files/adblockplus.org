server {
  listen 8080;
  root /var/www/adblockplus.org/httpdocs;

  location / {
    index index.php index index.html;

    set $preferredLang en;
    if ($http_accept_language ~ ^(\w\w)\b) {
      set $preferredLang $1;
    }
    if (!-f $document_root/static/$preferredLang/index) {
      set $preferredLang en;
    }

    if ($arg_a ~ ^(view|show)?$) {
      rewrite ^/(index\.html)?$ /$preferredLang/? redirect;
      rewrite ^/(\w\w(_\w\w)?)$ /$1/ redirect;
    }

    rewrite ^/(\w\w)/installation$ /$1/ permanent;
    rewrite ^/anwiki/(.*) /$1 permanent;

    if (-f $request_filename) {
      break;
    }
    if (-d $request_filename) {
      break;
    }

    if ($http_user_agent ~ \bChrome/\d+) {
      rewrite ^/(\w\w(_\w\w)?)/?$ /$1/chrome;
    }
    if ($http_user_agent ~ \bPresto/\d+) {
      rewrite ^/(\w\w(_\w\w)?)/?$ /$1/opera;
    }
    if ($http_user_agent !~ \bChrome/\d+) {
      rewrite ^/(\w\w(_\w\w)?)/?$ /$1/firefox;
    }

    rewrite ^/(.*) /index.php?p=$1 last;
  }

  location ~ \.php$ {
    client_max_body_size 8m;

    fastcgi_pass unix:/tmp/php-fastcgi.sock;
    fastcgi_index index.php;

    fastcgi_param SCRIPT_FILENAME /var/www/adblockplus.org/phproot$fastcgi_script_name;

    fastcgi_param QUERY_STRING $query_string;
    fastcgi_param REQUEST_METHOD $request_method;
    fastcgi_param CONTENT_TYPE $content_type;
    fastcgi_param CONTENT_LENGTH $content_length;

    fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_param DOCUMENT_URI $document_uri;
    fastcgi_param DOCUMENT_ROOT $document_root;
    fastcgi_param SERVER_PROTOCOL $server_protocol;

    fastcgi_param GATEWAY_INTERFACE CGI/1.1;
    fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;

    fastcgi_param REMOTE_ADDR $remote_addr;
    fastcgi_param REMOTE_PORT $remote_port;
    fastcgi_param SERVER_ADDR $server_addr;
    fastcgi_param SERVER_PORT $server_port;
    fastcgi_param SERVER_NAME $server_name;
  }
}
